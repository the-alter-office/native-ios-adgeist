<!DOCTYPE html>
<html>
<head>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #ad-content {
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 100%;
            max-height: 100%;
        }
        #ad-content > * {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div id='ad-content'></div>
    <script src='https://cdn.adgeist.ai/adcard-beta.js'></script>
    <script>
        function initAd() {
            if (typeof AdCard === 'undefined') {
                console.error('‚ùå AdCard library not loaded');
                return;
            }
            try {
                const creativeData = JSON.parse("{{CREATIVE_DATA}}");
                const adCard = new AdCard(creativeData);
                const html = adCard.renderHtml();
                document.getElementById('ad-content').innerHTML = html;
                document.getElementById('ad-content').addEventListener('click', function(e) {
                    console.log('üëÜ Ad clicked');
                });
                
                function checkOverflow() {
                    try {
                        const adgeistCard = document.getElementById('adgeist-card');
                        if (!adgeistCard) {
                            console.error('‚ùå adgeist-card element not found');
                            return;
                        }
                        
                        const viewWidth = window.innerWidth;
                        const viewHeight = window.innerHeight;
                        const cardWidth = adgeistCard.scrollWidth;
                        const cardHeight = adgeistCard.scrollHeight;
                        
                        const widthOverflow = cardWidth > viewWidth;
                        const heightOverflow = cardHeight > viewHeight;
                        const hasOverflow = (widthOverflow || heightOverflow);
                        
                        console.log('Overflow check - View:', viewWidth + 'x' + viewHeight, 'Card:', cardWidth + 'x' + cardHeight, 'Overflow:', hasOverflow);
                        
                        if (hasOverflow) {
                            Android.reportOverflow(cardWidth, cardHeight, viewWidth, viewHeight);
                        } else {
                            Android.showAd();
                        }
                    } catch (e) {
                        console.error('‚ùå Error checking overflow:', e.message, e.stack);
                    }
                }
                
                if(creativeData.adspaceType === 'companion') {
                   // Use ResizeObserver to automatically detect when body gets valid dimensions
                   const resizeObserver = new ResizeObserver(function(entries) {
                       const viewWidth = window.innerWidth;
                       const viewHeight = window.innerHeight;
                       
                       if (viewWidth > 0 && viewHeight > 0) {
                           resizeObserver.disconnect();
                           checkOverflow();
                       }
                   });
                   
                   resizeObserver.observe(document.body);
                   
                   // Fallback: Check immediately in case dimensions are already available
                   if (window.innerWidth > 0 && window.innerHeight > 0) {
                       resizeObserver.disconnect();
                       checkOverflow();
                   }
                }
            } catch (error) {
                console.error('‚ùå Error rendering ad:', error.message);
                console.error('Stack trace:', error.stack);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(initAd, 100);
            });
        } else {
            setTimeout(initAd, 100);
        }
    </script>
</body>
</html>
